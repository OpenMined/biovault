setup:
  server:
    - "./tests/scripts/devstack.sh --reset --clients client1@sandbox.local,client2@sandbox.local,aggregator@sandbox.local"

steps:
  - name: Initialize BioVault for client1
    datasite: client1@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv init client1@sandbox.local --quiet

  - name: Initialize BioVault for client2
    datasite: client2@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv init client2@sandbox.local --quiet

  - name: Initialize BioVault for aggregator
    datasite: aggregator@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv init aggregator@sandbox.local --quiet

  # Smoke test: verify SyftBox sync is working
  - name: Wait for client1 public key to sync to client2
    datasite: client2@sandbox.local
    wait_for: datasites/client1@sandbox.local/public/crypto/did.json
    timeout: 30

  - name: Wait for client2 public key to sync to client1
    datasite: client1@sandbox.local
    wait_for: datasites/client2@sandbox.local/public/crypto/did.json
    timeout: 30

  - name: Wait for aggregator public key to sync to client1
    datasite: client1@sandbox.local
    wait_for: datasites/aggregator@sandbox.local/public/crypto/did.json
    timeout: 30

  - name: Smoke test sync complete
    run: |
      echo "SyftBox sync smoke test passed - public keys are syncing"

  # Permissions are created declaratively by the flow.yaml init_permissions step
  # run_id is auto-generated by the scenario runner for distributed flow coordination
  # BV_SYQURE_USE_DOCKER is inherited from environment (set by --docker flag)
  # SyftBox devstack handles file sync between parties
  - parallel:
      - name: client1-flow
        datasite: client1@sandbox.local
        run: |
          cd {{workspace}}
          BIOVAULT_FLOW_VERBOSE=1 BIOVAULT_FLOW_RUN_ID={{run_id}} \
          BV_SYQURE_USE_DOCKER=${BV_SYQURE_USE_DOCKER:-} \
            {{workspace}}/cli/target/release/bv run tests/scenarios/syqure-flow/flow-he.yaml

      - name: client2-flow
        datasite: client2@sandbox.local
        run: |
          cd {{workspace}}
          BIOVAULT_FLOW_VERBOSE=1 BIOVAULT_FLOW_RUN_ID={{run_id}} \
          BV_SYQURE_USE_DOCKER=${BV_SYQURE_USE_DOCKER:-} \
            {{workspace}}/cli/target/release/bv run tests/scenarios/syqure-flow/flow-he.yaml

      - name: aggregator-flow
        datasite: aggregator@sandbox.local
        run: |
          cd {{workspace}}
          BIOVAULT_FLOW_VERBOSE=1 BIOVAULT_FLOW_RUN_ID={{run_id}} \
          BV_SYQURE_USE_DOCKER=${BV_SYQURE_USE_DOCKER:-} \
            {{workspace}}/cli/target/release/bv run tests/scenarios/syqure-flow/flow-he.yaml
    timeout: 900

  - name: Verify flow completion
    datasite: aggregator@sandbox.local
    run: |
      echo "=== Checking progress files for run {{run_id}} ==="

      # Structure: datasites/{ds}/shared/flows/syqure-flow/{run_id}/progress/progress.json
      # Each datasite writes to their own shared folder
      for ds in client1@sandbox.local client2@sandbox.local aggregator@sandbox.local; do
        PROGRESS_DIR="datasites/${ds}/shared/flows/syqure-flow/{{run_id}}/progress"
        PROGRESS_JSON="${PROGRESS_DIR}/progress.json"
        PROGRESS_LOG="${PROGRESS_DIR}/progress.log"

        echo ""
        echo "=== Progress for ${ds} ==="
        if [[ -f "$PROGRESS_JSON" ]]; then
          echo "progress.json:"
          cat "$PROGRESS_JSON"
        else
          echo "No progress.json found at ${PROGRESS_JSON}"
        fi

        if [[ -f "$PROGRESS_LOG" ]]; then
          echo ""
          echo "progress.log:"
          cat "$PROGRESS_LOG"
        fi
      done

      echo ""
      echo "=== DISTRIBUTED FLOW TEST COMPLETE ==="

  - name: Verify MPC aggregation result
    shell: bash
    run: |
      echo "=== Verifying MPC aggregation result ==="

      # Read inputs
      CLIENT1_COUNTS=$(cat {{workspace}}/results/flows/syqure-flow/align_counts/client1_sandbox_local/counts_array.json | tr -d '[:space:]')
      CLIENT2_COUNTS=$(cat {{workspace}}/results/flows/syqure-flow/align_counts/client2_sandbox_local/counts_array.json | tr -d '[:space:]')

      # Read results from CLIENTS (not aggregator - aggregator is trusted dealer with no revealed values)
      RESULT_CLIENT1=$(cat {{workspace}}/results/flows/syqure-flow/secure_aggregate/client1_sandbox_local/aggregated_counts.json | tr -d '[:space:]')
      RESULT_CLIENT2=$(cat {{workspace}}/results/flows/syqure-flow/secure_aggregate/client2_sandbox_local/aggregated_counts.json | tr -d '[:space:]')
      RESULT_AGG=$(cat {{workspace}}/results/flows/syqure-flow/secure_aggregate/aggregator_sandbox_local/aggregated_counts.json | tr -d '[:space:]')

      echo "Client1 input:  $CLIENT1_COUNTS"
      echo "Client2 input:  $CLIENT2_COUNTS"
      echo "Result client1: $RESULT_CLIENT1"
      echo "Result client2: $RESULT_CLIENT2"
      echo "Result agg:     $RESULT_AGG (expected zeros - trusted dealer)"

      # Parse arrays and compute expected sum using Python
      EXPECTED=$(python3 -c "
      import json
      c1 = json.loads('$CLIENT1_COUNTS')
      c2 = json.loads('$CLIENT2_COUNTS')
      expected = [a + b for a, b in zip(c1, c2)]
      print(json.dumps(expected, separators=(',', ':')))
      ")

      echo "Expected:       $EXPECTED"

      # Both clients should have the same correct result
      if [ "$RESULT_CLIENT1" = "$EXPECTED" ] && [ "$RESULT_CLIENT2" = "$EXPECTED" ]; then
        echo "✓ MPC aggregation result is correct!"
      else
        echo "✗ ERROR: MPC result does not match expected sum"
        echo "  Client1 got: $RESULT_CLIENT1"
        echo "  Client2 got: $RESULT_CLIENT2"
        exit 1
      fi
