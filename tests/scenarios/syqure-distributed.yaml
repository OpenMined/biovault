setup:
  server:
    - "SYFTBOX_HOTLINK=${BV_SYFTBOX_HOTLINK-1} SYFTBOX_HOTLINK_SOCKET_ONLY=1 SYFTBOX_HOTLINK_TCP_PROXY=${BV_SYQURE_TCP_PROXY-1} SYFTBOX_HOTLINK_TCP_PROXY_ADDR=${BV_SYFTBOX_HOTLINK_TCP_PROXY_ADDR-127.0.0.1} SYFTBOX_HOTLINK_QUIC=${BV_SYFTBOX_HOTLINK_QUIC-1} SYFTBOX_HOTLINK_QUIC_ONLY=${BV_SYFTBOX_HOTLINK_QUIC_ONLY-0} BV_SYQURE_TCP_PROXY=${BV_SYQURE_TCP_PROXY-1} ./tests/scripts/devstack.sh --reset --clients client1@sandbox.local,client2@sandbox.local,aggregator@sandbox.local"

steps:
  - name: Initialize BioVault for client1
    datasite: client1@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv init client1@sandbox.local --quiet

  - name: Initialize BioVault for client2
    datasite: client2@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv init client2@sandbox.local --quiet

  - name: Initialize BioVault for aggregator
    datasite: aggregator@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv init aggregator@sandbox.local --quiet

  # Smoke test: verify SyftBox sync is working
  - name: Wait for client1 public key to sync to client2
    datasite: client2@sandbox.local
    wait_for: datasites/client1@sandbox.local/public/crypto/did.json
    timeout: 30

  - name: Wait for client2 public key to sync to client1
    datasite: client1@sandbox.local
    wait_for: datasites/client2@sandbox.local/public/crypto/did.json
    timeout: 30

  - name: Wait for aggregator public key to sync to client1
    datasite: client1@sandbox.local
    wait_for: datasites/aggregator@sandbox.local/public/crypto/did.json
    timeout: 30

  - name: Smoke test sync complete
    run: |
      echo "SyftBox sync smoke test passed - public keys are syncing"

  - name: Select Syqure aggregation mode
    run: |
      MODE="${BV_SYQURE_AGG_MODE:-smpc}"
      TRANSPORT="${BV_SYQURE_TRANSPORT:-hotlink}"
      MODULE_YAML="{{workspace}}/tests/scenarios/syqure-flow/modules/secure-aggregate/module.yaml"
      case "$MODE" in
        he) ENTRY="he_aggregate.codon" ;;
        smpc|"") ENTRY="smpc_aggregate.codon" ;;
        *)
          echo "Unknown BV_SYQURE_AGG_MODE: $MODE (expected smpc|he)" >&2
          exit 1
          ;;
      esac
      python3 -c "import pathlib,re; path = pathlib.Path(\"${MODULE_YAML}\"); text = path.read_text(); text = text.replace(\"entrypoint: smpc_aggregate.codon\", f\"entrypoint: ${ENTRY}\"); text = text.replace(\"entrypoint: he_aggregate.codon\", f\"entrypoint: ${ENTRY}\"); text = re.sub(r\"transport: .*\", f\"transport: ${TRANSPORT}\", text); path.write_text(text)"
      echo "Syqure aggregation mode: ${MODE} (entrypoint: ${ENTRY}) transport: ${TRANSPORT}"

  # Permissions are created declaratively by the flow.yaml init_permissions step
  # run_id is auto-generated by the scenario runner for distributed flow coordination
  # BV_SYQURE_USE_DOCKER is inherited from environment (set by --docker flag)
  # SyftBox devstack handles file sync between parties
  - parallel:
      - name: client1-flow
        datasite: client1@sandbox.local
        run: |
          cd {{workspace}}
          TIMEFORMAT='flow_time:%3R'
          BIOVAULT_FLOW_VERBOSE=1 BIOVAULT_FLOW_RUN_ID={{run_id}} \
          BV_SYQURE_USE_DOCKER=${BV_SYQURE_USE_DOCKER:-} \
            time {{workspace}}/cli/target/release/bv run tests/scenarios/syqure-flow/flow.yaml

      - name: client2-flow
        datasite: client2@sandbox.local
        run: |
          cd {{workspace}}
          TIMEFORMAT='flow_time:%3R'
          BIOVAULT_FLOW_VERBOSE=1 BIOVAULT_FLOW_RUN_ID={{run_id}} \
          BV_SYQURE_USE_DOCKER=${BV_SYQURE_USE_DOCKER:-} \
            time {{workspace}}/cli/target/release/bv run tests/scenarios/syqure-flow/flow.yaml

      - name: aggregator-flow
        datasite: aggregator@sandbox.local
        run: |
          cd {{workspace}}
          TIMEFORMAT='flow_time:%3R'
          BIOVAULT_FLOW_VERBOSE=1 BIOVAULT_FLOW_RUN_ID={{run_id}} \
          BV_SYQURE_USE_DOCKER=${BV_SYQURE_USE_DOCKER:-} \
            time {{workspace}}/cli/target/release/bv run tests/scenarios/syqure-flow/flow.yaml
    timeout: 900

  - name: Verify flow completion
    datasite: aggregator@sandbox.local
    run: |
      echo "=== Checking progress files for run {{run_id}} ==="

      # Structure: datasites/{ds}/shared/flows/syqure-flow/{run_id}/progress/progress.json
      # Each datasite writes to their own shared folder
      for ds in client1@sandbox.local client2@sandbox.local aggregator@sandbox.local; do
        PROGRESS_DIR="datasites/${ds}/shared/flows/syqure-flow/{{run_id}}/progress"
        PROGRESS_JSON="${PROGRESS_DIR}/progress.json"
        PROGRESS_LOG="${PROGRESS_DIR}/progress.log"

        echo ""
        echo "=== Progress for ${ds} ==="
        if [[ -f "$PROGRESS_JSON" ]]; then
          echo "progress.json:"
          cat "$PROGRESS_JSON"
        else
          echo "No progress.json found at ${PROGRESS_JSON}"
        fi

        if [[ -f "$PROGRESS_LOG" ]]; then
          echo ""
          echo "progress.log:"
          cat "$PROGRESS_LOG"
        fi
      done

      echo ""
      echo "=== DISTRIBUTED FLOW TEST COMPLETE ==="

  - name: Verify aggregation result
    shell: bash
    run: |
      if [[ "${BV_SYQURE_HE:-0}" = "1" ]]; then
        RESULT_LABEL="HE"
      else
        RESULT_LABEL="MPC"
      fi
      echo "=== Verifying ${RESULT_LABEL} aggregation result ==="

      # Read inputs
      CLIENT1_COUNTS=$(cat {{workspace}}/results/flows/syqure-flow/align_counts/client1_sandbox_local/counts_array.json | tr -d '[:space:]')
      CLIENT2_COUNTS=$(cat {{workspace}}/results/flows/syqure-flow/align_counts/client2_sandbox_local/counts_array.json | tr -d '[:space:]')

      # Read results from CLIENTS (not aggregator - aggregator is trusted dealer with no revealed values)
      RESULT_CLIENT1=$(cat {{workspace}}/results/flows/syqure-flow/secure_aggregate/client1_sandbox_local/aggregated_counts.json | tr -d '[:space:]')
      RESULT_CLIENT2=$(cat {{workspace}}/results/flows/syqure-flow/secure_aggregate/client2_sandbox_local/aggregated_counts.json | tr -d '[:space:]')
      RESULT_AGG=$(cat {{workspace}}/results/flows/syqure-flow/secure_aggregate/aggregator_sandbox_local/aggregated_counts.json | tr -d '[:space:]')

      echo "Client1 input:  $CLIENT1_COUNTS"
      echo "Client2 input:  $CLIENT2_COUNTS"
      echo "Result client1: $RESULT_CLIENT1"
      echo "Result client2: $RESULT_CLIENT2"
      echo "Result agg:     $RESULT_AGG (expected zeros - trusted dealer)"

      # Parse arrays and compute expected sum using Python
      EXPECTED=$(python3 -c "
      import json
      c1 = json.loads('$CLIENT1_COUNTS')
      c2 = json.loads('$CLIENT2_COUNTS')
      expected = [a + b for a, b in zip(c1, c2)]
      print(json.dumps(expected, separators=(',', ':')))
      ")

      echo "Expected:       $EXPECTED"

      # Both clients should have the same correct result
      if [ "$RESULT_CLIENT1" = "$EXPECTED" ] && [ "$RESULT_CLIENT2" = "$EXPECTED" ]; then
        echo "✓ ${RESULT_LABEL} aggregation result is correct!"
      else
        echo "✗ ERROR: ${RESULT_LABEL} result does not match expected sum"
        echo "  Client1 got: $RESULT_CLIENT1"
        echo "  Client2 got: $RESULT_CLIENT2"
        exit 1
      fi
