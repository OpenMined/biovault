# Sync + Permissions Scenario (BioVault)
# Covers:
# - RPC message delivery + journal entry for downloaded requests
# - Session invite/accept (rpc/session)
# - Shared submissions + results path sync
# - Permission errors: ensure read-only peer files are not auto-uploaded
#   and explicit unauthorized edits are rejected
#
# Run with: ./test-scenario.sh tests/scenarios/sync-permissions.yaml

setup:
  server:
    - "./tests/scripts/devstack.sh --reset --clients client1@sandbox.local,client2@sandbox.local"

steps:
  - name: Seed genotype fixtures for both clients
    run: |
      ./tests/scripts/import-data.sh \
        --csv {{workspace}}/cli/tests/data/participants_all.csv \
        --clients client1@sandbox.local,client2@sandbox.local \
        --path-column genotype_file

  - name: Wait for client1 public key to sync
    datasite: client2@sandbox.local
    wait_for: datasites/client1@sandbox.local/public/crypto/did.json
    timeout: 30

  - name: Wait for client2 public key to sync
    datasite: client1@sandbox.local
    wait_for: datasites/client2@sandbox.local/public/crypto/did.json
    timeout: 30

  - name: Client1 imports Client2 bundle
    datasite: client1@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv syc import \
        datasites/client2@sandbox.local/public/crypto/did.json \
        --expected-identity client2@sandbox.local

  - name: Client2 imports Client1 bundle
    datasite: client2@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv syc import \
        datasites/client1@sandbox.local/public/crypto/did.json \
        --expected-identity client1@sandbox.local

  - name: Client1 journal tracks client2 DID
    datasite: client1@sandbox.local
    run: |
      COUNT=$(sqlite3 .data/sync.db "select count(*) from sync_journal where path='client2@sandbox.local/public/crypto/did.json'")
      echo "count=${COUNT}"
      test "${COUNT}" -ge 1

  - name: Client1 sends RPC message to client2
    datasite: client1@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv message send \
        client2@sandbox.local \
        "Sync journal smoke test" \
        --subject "RPC Sync Check"

  - name: Wait for RPC request file to arrive at client2
    datasite: client2@sandbox.local
    wait_for: datasites/client2@sandbox.local/app_data/biovault/rpc/message/*.request
    wait_for_new: true
    timeout: 30

  - name: Capture RPC request file path
    datasite: client2@sandbox.local
    run: |
      ls -t datasites/client2@sandbox.local/app_data/biovault/rpc/message/*.request | head -n 1
    capture: rpc_request_path

  - name: Client2 journal tracks RPC request download
    datasite: client2@sandbox.local
    run: |
      KEY="{{rpc_request_path}}"
      KEY="${KEY#datasites/}"
      COUNT=$(sqlite3 .data/sync.db "select count(*) from sync_journal where path='${KEY}'")
      echo "count=${COUNT} key=${KEY}"
      test "${COUNT}" -ge 1

  - name: Client2 syncs inbox to ingest request
    datasite: client2@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv message sync --no-cleanup

  - name: Assert no rejected markers in client2 RPC message folder
    datasite: client2@sandbox.local
    run: |
      if find datasites/client2@sandbox.local/app_data/biovault/rpc/message -name "*rejected*" -print -quit | grep -q .; then
        echo "Unexpected rejected markers under rpc/message"
        find datasites/client2@sandbox.local/app_data/biovault/rpc/message -name "*rejected*"
        exit 1
      fi

  - name: Client1 creates a session and invites client2
    datasite: client1@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv session create \
        "Sync Permissions Session" \
        --peer client2@sandbox.local \
        --description "sync-permissions"

  - name: Capture session id
    datasite: client1@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv session list --json | jq -r '
        map(select(.name=="Sync Permissions Session"))
        | .[0].session_id // empty
      '
    capture: session_id

  - name: Wait for session invite request at client2
    datasite: client2@sandbox.local
    wait_for: datasites/client2@sandbox.local/app_data/biovault/rpc/session/{{session_id}}.request
    timeout: 30

  - name: Client2 syncs inbox to ingest session invite
    datasite: client2@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv message sync --no-cleanup

  - name: Client2 accepts the session invitation
    datasite: client2@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv session accept "{{session_id}}"

  - name: Wait for session response file to sync back to client1
    datasite: client1@sandbox.local
    wait_for: datasites/client1@sandbox.local/app_data/biovault/rpc/session/{{session_id}}.response
    timeout: 30

  - name: Client1 syncs inbox to ingest session response
    datasite: client1@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv message sync --no-cleanup

  - name: Assert no peer RPC session ACL created on client2
    datasite: client2@sandbox.local
    run: |
      test ! -f datasites/client1@sandbox.local/app_data/biovault/rpc/session/syft.pub.yaml

  - name: Assert no peer RPC session ACL created on client1
    datasite: client1@sandbox.local
    run: |
      test ! -f datasites/client2@sandbox.local/app_data/biovault/rpc/session/syft.pub.yaml

  - name: Client1 submits count-lines project to client2
    datasite: client1@sandbox.local
    run: |
      rm -rf count-lines
      mkdir -p count-lines
      cp -R "{{workspace}}/cli/examples/pipeline/count-lines/." count-lines/
      {{workspace}}/cli/target/release/bv submit count-lines \
        client2@sandbox.local \
        --non-interactive \
        --force

  - name: Wait for project.yaml to sync to client2
    datasite: client2@sandbox.local
    wait_for: datasites/client1@sandbox.local/shared/biovault/submissions/*/project.yaml
    timeout: 60

  - name: Capture submission path
    datasite: client2@sandbox.local
    run: |
      ls -td datasites/client1@sandbox.local/shared/biovault/submissions/* | head -n 1
    capture: submission_path

  - name: Capture submission folder name
    datasite: client2@sandbox.local
    run: |
      basename "{{submission_path}}"
    capture: submission_dir

  - name: Client2 journal tracks downloaded project.yaml
    datasite: client2@sandbox.local
    run: |
      KEY="client1@sandbox.local/shared/biovault/submissions/{{submission_dir}}/project.yaml"
      COUNT=$(sqlite3 .data/sync.db "select count(*) from sync_journal where path='${KEY}'")
      echo "count=${COUNT} key=${KEY}"
      test "${COUNT}" -ge 1

  - name: Ensure no rejected project marker before mutation
    datasite: client2@sandbox.local
    run: |
      test ! -f "datasites/client1@sandbox.local/shared/biovault/submissions/{{submission_dir}}/project.rejected.yaml"

  - name: Client2 syncs inbox to ingest project message
    datasite: client2@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv message sync --no-cleanup

  - name: Client2 captures inbox JSON
    datasite: client2@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv inbox --plain --json
    capture: inbox_json

  - name: Extract project message id
    datasite: client2@sandbox.local
    run: |
      jq -r '
        .messages[]
        | select((.message_type | type) == "object" and .message_type.Project != null)
        | .id
      ' <<< '{{inbox_json}}' | head -n 1
    capture: project_msg_id

  - name: Client2 processes project (test mode, approve)
    datasite: client2@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv message process "{{project_msg_id}}" \
        --test \
        --participant ALL \
        --approve \
        --non-interactive

  - name: Wait for results to sync to client1
    datasite: client1@sandbox.local
    wait_for: datasites/client1@sandbox.local/shared/biovault/submissions/*/results/ALL/line_counts.csv
    timeout: 120

  - name: Client2 attempts forbidden edit of project.yaml (should be rejected)
    datasite: client2@sandbox.local
    run: |
      echo "# forbidden edit" >> "datasites/client1@sandbox.local/shared/biovault/submissions/{{submission_dir}}/project.yaml"

  - name: Wait for rejected marker on unauthorized edit
    datasite: client2@sandbox.local
    wait_for: datasites/client1@sandbox.local/shared/biovault/submissions/{{submission_dir}}/project.rejected.yaml
    timeout: 60
