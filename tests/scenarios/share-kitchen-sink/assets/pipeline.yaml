name: share-kitchen-sink
version: 0.1.0

inputs:
  wait_seconds:
    type: String
    default: "120"

datasites: &datasites
  - aggregator@sandbox.local
  - client1@sandbox.local
  - client2@sandbox.local

clients: &clients
  - client1@sandbox.local
  - client2@sandbox.local

steps:
- id: write
  uses: ./share-write
  runs_on: *datasites
  share:
    hello_shared:
      source: hello
      path: shared/biovault/kitchen/{run_id}/{current_datasite}/hello.txt
      read: *datasites
      write: *datasites

- id: client_tag
  uses: ./share-clients
  runs_on: *clients
  with:
    hello_file: step.write.outputs.hello
  share:
    tagged_shared:
      source: tagged
      path: shared/biovault/kitchen/{run_id}/{current_datasite}/tagged_hello.txt
      read: *datasites
      write: *datasites

- id: collect
  uses: ./share-collect
  runs_on: aggregator@sandbox.local
  with:
    shared_paths: step.client_tag.outputs.tagged_shared.manifest
    wait_seconds: inputs.wait_seconds

- id: rebroadcast
  uses: ./share-rebroadcast
  runs_on: aggregator@sandbox.local
  with:
    combined: step.collect.outputs.combined
  share:
    combined_shared:
      source: combined
      path: shared/biovault/kitchen/{run_id}/combined/combined_hello.txt
      read: *datasites
      write: *datasites

- id: wait_clients
  uses: ./share-wait
  runs_on: *clients
  with:
    combined_path: step.rebroadcast.outputs.combined_shared
    wait_seconds: inputs.wait_seconds
