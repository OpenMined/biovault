import os

from sequre import mpc, sequre, Sharetensor as ST


def load_vector(path: str):
    data = []
    if not path:
        return data
    try:
        with open(path, "r") as fh:
            for line in fh:
                val = line.strip()
                if val == "":
                    continue
                data.append(int(val))
    except Exception:
        return []
    return data


def write_vector(path: str, data):
    if not path:
        return
    try:
        with open(path, "w") as fh:
            for val in data:
                fh.write(str(val))
                fh.write("\n")
    except Exception:
        pass


@sequre
def secure_add(mpc, a, b):
    return a + b


mpc = mpc()
print(f"I am Party: {mpc.pid}")

ac_path = os.getenv("BV_INPUT_AC", default="")
an_path = os.getenv("BV_INPUT_AN", default="")

ac = load_vector(ac_path)
an = load_vector(an_path)

n = len(ac)
if n == 0:
    n = len(an)
if n == 0:
    print("No input vectors provided")
    n = 0

zeros = [0 for _ in range(n)]

ac_a = ST.enc(
    mpc, ac if mpc.pid == 1 else zeros, source_pid=1, modulus=mpc.default_mpc_modulus
)
ac_b = ST.enc(
    mpc, ac if mpc.pid == 2 else zeros, source_pid=2, modulus=mpc.default_mpc_modulus
)

an_a = ST.enc(
    mpc, an if mpc.pid == 1 else zeros, source_pid=1, modulus=mpc.default_mpc_modulus
)
an_b = ST.enc(
    mpc, an if mpc.pid == 2 else zeros, source_pid=2, modulus=mpc.default_mpc_modulus
)

sum_ac = secure_add(mpc, ac_a, ac_b)
sum_an = secure_add(mpc, an_a, an_b)

result_ac = sum_ac.reveal(mpc)
result_an = sum_an.reveal(mpc)

out_ac = os.getenv("BV_OUTPUT_SUM_AC", default=f"sum_ac_{mpc.pid}.txt")
out_an = os.getenv("BV_OUTPUT_SUM_AN", default=f"sum_an_{mpc.pid}.txt")

write_vector(out_ac, result_ac)
write_vector(out_an, result_an)

if mpc.pid == 0:
    print(f"CP0 (aggregator): sum_ac_len={len(result_ac)} sum_an_len={len(result_an)}")
