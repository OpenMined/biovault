apiVersion: syftbox.openmined.org/v1alpha1
kind: Flow
metadata:
  name: allele-freq-syqure
  version: 0.1.0
  description: Distributed allele frequency flow with Syqure MPC aggregation.

spec:
  vars:
    flow_path: "syft://{datasite.current}/shared/flows/{flow_name}"
    run_path: "{vars.flow_path}/{run_id}"
    step_path: "{vars.run_path}/{step.number}-{step.id}"

  coordination:
    url: "{vars.run_path}/_progress"
    share_with: all

  mpc:
    url: "{vars.run_path}/_mpc"
    topology: mesh

  inputs:
    datasites:
      default:
        - aggregator@sandbox.local
        - client1@sandbox.local
        - client2@sandbox.local

  datasites:
    all: inputs.datasites
    groups:
      aggregator:
        include:
          - "{datasites[0]}"
      clients:
        include:
          - "{datasites[1]}"
          - "{datasites[2]}"

  modules:
    gen_allele_freq:
      source:
        kind: local
        path: ./modules/gen-allele-freq
      allow_dirty: true
      interface:
        outputs:
          - name: allele_freq_npz
            type: File
          - name: locus_index
            type: File
      assets:
        - path: run.sh

    build_master:
      source:
        kind: local
        path: ./modules/build-master
      allow_dirty: true
      interface:
        inputs:
          - name: index_manifest
            type: File
        outputs:
          - name: union_index
            type: File
          - name: count
            type: String
      assets:
        - path: run.sh
        - path: build_master.py

    align_counts:
      source:
        kind: local
        path: ./modules/align-counts
      allow_dirty: true
      interface:
        inputs:
          - name: union_index
            type: File
          - name: allele_freq_npz
            type: File
          - name: locus_index
            type: File
        outputs:
          - name: aligned_ac
            type: File
      assets:
        - path: run.sh
        - path: align_counts.py

    report_counts:
      source:
        kind: local
        path: ./modules/report-counts
      allow_dirty: true
      interface:
        inputs:
          - name: union_index
            type: File
          - name: aligned_ac
            type: File
        outputs:
          - name: report_json
            type: File
          - name: report_tsv
            type: File
      assets:
        - path: run.sh
        - path: report_counts.py

    secure_aggregate:
      source:
        kind: local
        path: ./modules/secure-aggregate
      allow_dirty: true
      interface:
        inputs:
          - name: counts
            type: File
          - name: array_length
            type: String
        outputs:
          - name: aggregated_counts
            type: File
      assets:
        - path: secure_aggregate.codon

    report_aggregate:
      source:
        kind: local
        path: ./modules/report-aggregate
      allow_dirty: true
      interface:
        inputs:
          - name: union_index
            type: File
          - name: aligned_ac
            type: File
          - name: aggregated_counts
            type: File
        outputs:
          - name: report_json
            type: File
          - name: report_tsv
            type: File
      assets:
        - path: run.sh
        - path: report_aggregate.py

  steps:
    - id: gen_allele_freq
      uses: gen_allele_freq
      run:
        targets: clients
        strategy: parallel
        timeout: 3600
      share:
        index_shared:
          source: self.outputs.locus_index
          url: "{vars.step_path}/locus_index.json"
          permissions:
            read: ["{datasites[0]}"]
            write: ["{datasite.current}"]

    - id: build_master
      uses: build_master
      run:
        targets: aggregator
        timeout: 600
      with:
        index_manifest: step.gen_allele_freq.share.index_shared.url_list
      share:
        union_index_shared:
          source: self.outputs.union_index
          url: "{vars.step_path}/union_locus_index.json"
          permissions:
            read: ["{datasites[*]}"]
            write: ["{datasites[0]}"]

    - id: align_counts
      uses: align_counts
      run:
        targets: clients
        strategy: parallel
      with:
        union_index: step.build_master.share.union_index_shared
        allele_freq_npz: step.gen_allele_freq.outputs.allele_freq_npz
        locus_index: step.gen_allele_freq.outputs.locus_index

    - id: report_counts
      uses: report_counts
      run:
        targets: clients
        strategy: parallel
      with:
        union_index: step.build_master.share.union_index_shared
        aligned_ac: step.align_counts.outputs.aligned_ac

    - id: mpc_barrier
      barrier:
        wait_for: align_counts
        targets: clients
        timeout: 900

    - id: secure_aggregate_ac
      uses: secure_aggregate
      run:
        targets: all
        strategy: parallel
      with:
        counts:
          value: step.align_counts.outputs.aligned_ac
          only: clients
        array_length:
          value: step.build_master.outputs.count
          only: aggregator
      share:
        result_shared:
          source: self.outputs.aggregated_counts
          url: "{vars.step_path}/sum_ac.json"
          permissions:
            read: ["{datasites[*]}"]
            write: ["{datasite.current}"]

    - id: report_aggregate
      uses: report_aggregate
      run:
        targets: clients
        strategy: parallel
      with:
        union_index: step.build_master.share.union_index_shared
        aligned_ac: step.align_counts.outputs.aligned_ac
        aggregated_counts: step.secure_aggregate_ac.outputs.aggregated_counts
