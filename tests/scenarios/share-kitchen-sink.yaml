# Share kitchen sink scenario (multi-datasite pipeline foreach)
# Run with: ./test-scenario.sh tests/scenarios/share-kitchen-sink.yaml

setup:
  server:
    - "./tests/scripts/devstack.sh --reset --clients client1@sandbox.local,client2@sandbox.local,aggregator@sandbox.local"

steps:
  - name: Wait for client1 public key to sync
    datasite: aggregator@sandbox.local
    wait_for: datasites/client1@sandbox.local/public/crypto/did.json
    timeout: 30

  - name: Wait for client2 public key to sync
    datasite: aggregator@sandbox.local
    wait_for: datasites/client2@sandbox.local/public/crypto/did.json
    timeout: 30

  - name: Ensure datasites roots exist
    run: |
      set -euo pipefail
      mkdir -p "{{sandbox}}/aggregator@sandbox.local/datasites"
      mkdir -p "{{sandbox}}/client1@sandbox.local/datasites"
      mkdir -p "{{sandbox}}/client2@sandbox.local/datasites"

  - name: Aggregator imports client1 bundle
    datasite: aggregator@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv syc import \
        datasites/client1@sandbox.local/public/crypto/did.json \
        --expected-identity client1@sandbox.local

  - name: Aggregator imports client2 bundle
    datasite: aggregator@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv syc import \
        datasites/client2@sandbox.local/public/crypto/did.json \
        --expected-identity client2@sandbox.local

  - name: Create share-kitchen-sink project folder
    datasite: aggregator@sandbox.local
    run: |
      rm -rf share-kitchen-sink
      cp -R "{{workspace}}/tests/scenarios/share-kitchen-sink" share-kitchen-sink

  - name: Submit share-kitchen-sink project to aggregator
    datasite: aggregator@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv submit share-kitchen-sink \
        aggregator@sandbox.local \
        --non-interactive \
        --force

  - name: Submit share-kitchen-sink project to client1
    datasite: aggregator@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv submit share-kitchen-sink \
        client1@sandbox.local \
        --non-interactive \
        --force

  - name: Submit share-kitchen-sink project to client2
    datasite: aggregator@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv submit share-kitchen-sink \
        client2@sandbox.local \
        --non-interactive \
        --force

  - name: Wait for aggregator public key to sync to client1
    datasite: client1@sandbox.local
    wait_for: datasites/aggregator@sandbox.local/public/crypto/did.json
    timeout: 30

  - name: Wait for aggregator public key to sync to client2
    datasite: client2@sandbox.local
    wait_for: datasites/aggregator@sandbox.local/public/crypto/did.json
    timeout: 30

  - name: Client1 imports aggregator bundle
    datasite: client1@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv syc import \
        datasites/aggregator@sandbox.local/public/crypto/did.json \
        --expected-identity aggregator@sandbox.local

  - name: Client2 imports aggregator bundle
    datasite: client2@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv syc import \
        datasites/aggregator@sandbox.local/public/crypto/did.json \
        --expected-identity aggregator@sandbox.local

  - name: Aggregator syncs inbox
    datasite: aggregator@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv message sync --no-cleanup

  - name: Client1 syncs inbox
    datasite: client1@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv message sync --no-cleanup

  - name: Client2 syncs inbox
    datasite: client2@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv message sync --no-cleanup

  - name: Aggregator lists inbox
    datasite: aggregator@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv inbox --plain --json --all
    capture: agg_inbox

  - name: Client1 lists inbox
    datasite: client1@sandbox.local
    run: |
      out=""
      for i in $(seq 1 30); do
        out="$({{workspace}}/cli/target/release/bv inbox --plain --json --all)"
        if echo "$out" | jq -e '.messages[] | select(.message_type.Project != null)' >/dev/null 2>&1; then
          break
        fi
        {{workspace}}/cli/target/release/bv message sync --no-cleanup >/dev/null 2>&1 || true
        sleep 1
      done
      echo "$out"
    capture: c1_inbox

  - name: Client2 lists inbox
    datasite: client2@sandbox.local
    run: |
      out=""
      for i in $(seq 1 30); do
        out="$({{workspace}}/cli/target/release/bv inbox --plain --json --all)"
        if echo "$out" | jq -e '.messages[] | select(.message_type.Project != null)' >/dev/null 2>&1; then
          break
        fi
        {{workspace}}/cli/target/release/bv message sync --no-cleanup >/dev/null 2>&1 || true
        sleep 1
      done
      echo "$out"
    capture: c2_inbox

  - name: Extract project message IDs
    datasite: aggregator@sandbox.local
    run: |
      jq -r '.messages[] | select(.message_type.Project != null and .to == "aggregator@sandbox.local") | .id' <<< '{{agg_inbox}}' | head -n 1
    capture: agg_msg

  - name: Extract client1 project message ID
    datasite: client1@sandbox.local
    run: |
      jq -r '.messages[] | select(.message_type.Project != null and .to == "client1@sandbox.local") | .id' <<< '{{c1_inbox}}' | head -n 1
    capture: c1_msg

  - name: Extract client2 project message ID
    datasite: client2@sandbox.local
    run: |
      jq -r '.messages[] | select(.message_type.Project != null and .to == "client2@sandbox.local") | .id' <<< '{{c2_inbox}}' | head -n 1
    capture: c2_msg

  - name: Process share-kitchen-sink project concurrently
    datasite: aggregator@sandbox.local
    run: |
      set -euo pipefail
      BV_BIN="{{workspace}}/cli/target/release/bv"
      SANDBOX_DIR="{{sandbox}}"

      HOME="${SANDBOX_DIR}/aggregator@sandbox.local" \
        BIOVAULT_HOME="${SANDBOX_DIR}/aggregator@sandbox.local/.biovault" \
        SYFTBOX_EMAIL="aggregator@sandbox.local" \
        SYFTBOX_DATA_DIR="${SANDBOX_DIR}/aggregator@sandbox.local" \
        SYFTBOX_CONFIG_PATH="${SANDBOX_DIR}/aggregator@sandbox.local/.syftbox/config.json" \
        BV_BIN="$BV_BIN" \
        "$BV_BIN" message process "{{agg_msg}}" --test --approve --sync --non-interactive &

      HOME="${SANDBOX_DIR}/client1@sandbox.local" \
        BIOVAULT_HOME="${SANDBOX_DIR}/client1@sandbox.local/.biovault" \
        SYFTBOX_EMAIL="client1@sandbox.local" \
        SYFTBOX_DATA_DIR="${SANDBOX_DIR}/client1@sandbox.local" \
        SYFTBOX_CONFIG_PATH="${SANDBOX_DIR}/client1@sandbox.local/.syftbox/config.json" \
        BV_BIN="$BV_BIN" \
        "$BV_BIN" message process "{{c1_msg}}" --test --approve --sync --non-interactive &

      HOME="${SANDBOX_DIR}/client2@sandbox.local" \
        BIOVAULT_HOME="${SANDBOX_DIR}/client2@sandbox.local/.biovault" \
        SYFTBOX_EMAIL="client2@sandbox.local" \
        SYFTBOX_DATA_DIR="${SANDBOX_DIR}/client2@sandbox.local" \
        SYFTBOX_CONFIG_PATH="${SANDBOX_DIR}/client2@sandbox.local/.syftbox/config.json" \
        BV_BIN="$BV_BIN" \
        "$BV_BIN" message process "{{c2_msg}}" --test --approve --sync --non-interactive &

      wait

  - name: Wait for aggregator combined output
    datasite: aggregator@sandbox.local
    wait_for: .biovault/runs/{{agg_msg}}/results-test/pipeline/collect/*/combined_hello.txt
    timeout: 180

  - name: Wait for client1 combined copy
    datasite: client1@sandbox.local
    wait_for: .biovault/runs/{{c1_msg}}/results-test/pipeline/wait_clients/*/combined_from_agg.txt
    timeout: 180

  - name: Wait for client2 combined copy
    datasite: client2@sandbox.local
    wait_for: .biovault/runs/{{c2_msg}}/results-test/pipeline/wait_clients/*/combined_from_agg.txt
    timeout: 180
