setup:
  server:
    - "./tests/scripts/devstack.sh --reset --clients client1@sandbox.local"

steps:
  - name: Import genotype fixtures for client1
    run: |
      ./tests/scripts/import-data.sh \
        --csv cli/tests/data/participants_all.csv \
        --clients client1@sandbox.local \
        --path-column genotype_file

  - name: Run HERC2 classifier flow
    run: |
      ./tests/scripts/run.sh \
        --datasite client1@sandbox.local \
        --project ../bioscript/examples/herc2/herc2-classifier/flow.yaml \
        --data all

  - name: Assert BioVault catalog contains 13 files
    datasite: client1@sandbox.local
    run: |
      DB="biovault.db"
      if [ ! -f "$DB" ]; then
        DB=".biovault/biovault.db"
      fi
      sqlite3 "$DB" "select count(*) from files"
    expect: "13"

  - name: Assert results TSV exists
    datasite: client1@sandbox.local
    run: |
      ls .sandbox-run/results | tail -n 1 | xargs -I{} test -f ".sandbox-run/results/{}/herc2/result_HERC2.tsv"
