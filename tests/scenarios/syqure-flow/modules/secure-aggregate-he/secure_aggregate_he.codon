from sequre import mpc
from sequre.types.ciphertensor import Ciphertensor
import sequre.lattiseq.ckks as ckks
from numpy.create import array, zeros
import os


def load_json(path: str) -> List[int]:
    """Load JSON array of ints from file. Pure Codon - no Python dependency."""
    if not path:
        return []
    content = open(path).read().strip()
    if not content or content == "[]":
        return []
    inner = content.strip("[]").strip()
    if not inner:
        return []
    result: List[int] = []
    for x in inner.split(","):
        x = x.strip()
        if x:
            result.append(int(x))
    return result


def save_json(path: str, data: List[int]):
    """Write JSON array to file. Pure Codon - no Python dependency."""
    parts: List[str] = []
    for x in data:
        parts.append(str(x))
    open(path, "w").write("[" + ",".join(parts) + "]")


def main():
    m = mpc()

    # Clients (pid 1,2) load their counts; aggregator (pid 0) has none
    data = load_json(os.getenv("SEQURE_INPUT_COUNTS", ""))
    n = len(data)
    if n == 0:
        # Try reading array_length from file (SEQURE_INPUT_ARRAY_LENGTH points to a file)
        array_length_file = os.getenv("SEQURE_INPUT_ARRAY_LENGTH", "")
        if array_length_file:
            try:
                n = int(open(array_length_file).read().strip())
            except:
                pass
        if n == 0:
            n = int(os.getenv("SEQURE_ARRAY_LENGTH", "0"))

    if n == 0:
        print(f"ERROR: CP{m.pid} has no data and no array_length - check flow configuration")
        m.done()
        return

    # Sync all parties before starting MHE computation
    print(f"CP{m.pid}: Waiting for all parties to sync...")
    m.comms.sync_parties()
    print(f"CP{m.pid}: All parties synced!")

    if m.pid > 0:
        data_vec = array(data, dtype=float) if data else zeros((n,), dtype=float)
        local_ct = Ciphertensor[ckks.Ciphertext].enc(m, data_vec)

        if m.pid == 1:
            other_ct = m.comms.receive_as_jar(2, Ciphertensor[ckks.Ciphertext])
            total = local_ct.add(m, other_ct)
            m.comms.send_as_jar(total, 2)
        else:
            m.comms.send_as_jar(local_ct, 1)
            total = m.comms.receive_as_jar(1, Ciphertensor[ckks.Ciphertext])

        revealed_raw = total.reveal(m, T=float)
        revealed = array(revealed_raw, dtype=float).flatten().tolist()
        result: List[int] = []
        for x in revealed:
            result.append(int(round(x)))
    else:
        result = [0 for _ in range(n)]

    save_json(os.getenv("SEQURE_OUTPUT_AGGREGATED_COUNTS", "out.json"), result)
    m.done()


main()
