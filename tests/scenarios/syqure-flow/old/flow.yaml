apiVersion: syftbox.openmined.org/v1alpha1
kind: Flow
metadata:
  name: syqure-flow
  version: 0.1.0
  description: Multi-party flow for sharing rsids and aggregating counts.
  authors:
    - syqure@openmined.org
spec:
  inputs:
    datasites:
      type: List[String]
      default:
        - client1@sandbox.local
        - client2@sandbox.local
        - aggregator@sandbox.local

  datasites:
    all: inputs.datasites
    groups:
      all:
        include:
          - "{datasites[*]}"
      clients:
        include:
          - "{datasites[0]}"
          - "{datasites[1]}"
      aggregator:
        include:
          - "{datasites[2]}"

  modules:
    gen_variants:
      source:
        kind: local
        path: ./syqure-flow-modules/gen-variants
      allow_dirty: true
    build_master:
      source:
        kind: local
        path: ./syqure-flow-modules/build-master
      allow_dirty: true
    align_counts:
      source:
        kind: local
        path: ./syqure-flow-modules/align-counts
      allow_dirty: true
    aggregate_counts:
      source:
        kind: local
        path: ./syqure-flow-modules/aggregate-counts
      allow_dirty: true

  steps:
    # Phase 1: Clients generate their rsids and counts
    - id: gen_variants
      uses: gen_variants
      run:
        targets: clients
        strategy: parallel
      share:
        rsids_shared:
          source: rsids
          path: shared/flows/syqure/{run_id}/{datasite.current}/rsids.txt
          permissions:
            read:
              - "{datasites[*]}"
            write:
              - "{datasites[*]}"
        counts_shared:
          source: counts
          path: shared/flows/syqure/{run_id}/{datasite.current}/counts.json
          permissions:
            read:
              - "{datasites[*]}"
            write:
              - "{datasites[*]}"

    # Phase 2: Aggregator builds sorted master list from all rsids
    - id: build_master
      uses: build_master
      run:
        targets: aggregator
      with:
        rsids_manifest:
          from: steps.gen_variants.outputs.rsids_shared.manifest
          await:
            timeout_seconds: 120
            poll_ms: 200
      share:
        master_list_shared:
          source: master_list
          path: shared/flows/syqure/{run_id}/results/master_list.txt
          permissions:
            read:
              - "{datasites[*]}"
            write:
              - "{datasites[2]}"

    # Phase 3: Clients align their counts to the master list
    - id: align_counts
      uses: align_counts
      run:
        targets: clients
        strategy: parallel
      with:
        master_list:
          from: steps.build_master.outputs.master_list_shared
          await:
            timeout_seconds: 120
            poll_ms: 200
        counts: steps.gen_variants.outputs.counts
      share:
        counts_array_shared:
          source: counts_array
          path: shared/flows/syqure/{run_id}/{datasite.current}/counts_array.json
          permissions:
            read:
              - "{datasites[*]}"
            write:
              - "{datasites[*]}"

    # Phase 4: Aggregator sums the aligned count arrays
    - id: aggregate_counts
      uses: aggregate_counts
      run:
        targets: aggregator
      with:
        counts_manifest:
          from: steps.align_counts.outputs.counts_array_shared.manifest
          await:
            timeout_seconds: 120
            poll_ms: 200
      share:
        aggregated_shared:
          source: aggregated_counts
          path: shared/flows/syqure/{run_id}/results/aggregated_counts.json
          permissions:
            read:
              - "{datasites[*]}"
            write:
              - "{datasites[2]}"
