# Syqure allele frequency aggregation scenario
# Run with: ./test-scenario.sh tests/scenarios/syqure-allele-freq.yaml

setup:
  server:
    - "./tests/scripts/devstack.sh --reset --clients client1@sandbox.local,client2@sandbox.local,aggregator@sandbox.local"

steps:
  - name: Wait for client1 public key to sync
    datasite: aggregator@sandbox.local
    wait_for: datasites/client1@sandbox.local/public/crypto/did.json
    timeout: 30

  - name: Wait for client2 public key to sync
    datasite: aggregator@sandbox.local
    wait_for: datasites/client2@sandbox.local/public/crypto/did.json
    timeout: 30

  - name: Ensure datasites roots exist
    run: |
      set -euo pipefail
      mkdir -p "{{sandbox}}/aggregator@sandbox.local/datasites"
      mkdir -p "{{sandbox}}/client1@sandbox.local/datasites"
      mkdir -p "{{sandbox}}/client2@sandbox.local/datasites"

  - name: Aggregator imports client1 bundle
    datasite: aggregator@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv syc import \
        datasites/client1@sandbox.local/public/crypto/did.json \
        --expected-identity client1@sandbox.local

  - name: Aggregator imports client2 bundle
    datasite: aggregator@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv syc import \
        datasites/client2@sandbox.local/public/crypto/did.json \
        --expected-identity client2@sandbox.local

  - name: Create Syqure allele-freq project folder
    datasite: aggregator@sandbox.local
    run: |
      rm -rf syqure-allele-freq
      cp -R "{{workspace}}/tests/scenarios/allele-freq/syqure-allele-freq" syqure-allele-freq

  - name: Submit Syqure allele-freq project to aggregator
    datasite: aggregator@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv submit syqure-allele-freq \
        aggregator@sandbox.local \
        --non-interactive \
        --force

  - name: Submit Syqure allele-freq project to client1
    datasite: aggregator@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv submit syqure-allele-freq \
        client1@sandbox.local \
        --non-interactive \
        --force

  - name: Submit Syqure allele-freq project to client2
    datasite: aggregator@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv submit syqure-allele-freq \
        client2@sandbox.local \
        --non-interactive \
        --force

  - name: Wait for aggregator public key to sync to client1
    datasite: client1@sandbox.local
    wait_for: datasites/aggregator@sandbox.local/public/crypto/did.json
    timeout: 30

  - name: Wait for aggregator public key to sync to client2
    datasite: client2@sandbox.local
    wait_for: datasites/aggregator@sandbox.local/public/crypto/did.json
    timeout: 30

  - name: Client1 imports aggregator bundle
    datasite: client1@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv syc import \
        datasites/aggregator@sandbox.local/public/crypto/did.json \
        --expected-identity aggregator@sandbox.local

  - name: Client2 imports aggregator bundle
    datasite: client2@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv syc import \
        datasites/aggregator@sandbox.local/public/crypto/did.json \
        --expected-identity aggregator@sandbox.local

  - name: Generate genotype data for all parties (parallel)
    run: |
      set -euo pipefail
      script="{{workspace}}/tests/scripts/gen_allele_freq_data.sh"
      agg_dir="{{sandbox}}/aggregator@sandbox.local/private/app_data/biovault/allele-freq-data"
      c1_dir="{{sandbox}}/client1@sandbox.local/private/app_data/biovault/allele-freq-data"
      c2_dir="{{sandbox}}/client2@sandbox.local/private/app_data/biovault/allele-freq-data"

      ("$script" --output-dir "$agg_dir" --count 10 --seed 41 --force) &
      ("$script" --output-dir "$c1_dir" --count 100 --seed 42 --apol1 0.8 --force) &
      ("$script" --output-dir "$c2_dir" --count 100 --seed 43 --thal 0.8 --force) &
      wait

  - name: Aggregator syncs inbox
    datasite: aggregator@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv message sync --no-cleanup

  - name: Client1 syncs inbox
    datasite: client1@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv message sync --no-cleanup

  - name: Client2 syncs inbox
    datasite: client2@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv message sync --no-cleanup

  - name: Aggregator lists inbox
    datasite: aggregator@sandbox.local
    run: |
      {{workspace}}/cli/target/release/bv inbox --plain --json --all
    capture: agg_inbox

  - name: Client1 lists inbox
    datasite: client1@sandbox.local
    run: |
      out=""
      for i in $(seq 1 30); do
        out="$({{workspace}}/cli/target/release/bv inbox --plain --json --all)"
        if echo "$out" | jq -e '.messages[] | select(.message_type.Project != null)' >/dev/null 2>&1; then
          break
        fi
        {{workspace}}/cli/target/release/bv message sync --no-cleanup >/dev/null 2>&1 || true
        sleep 1
      done
      echo "$out"
    capture: c1_inbox

  - name: Client2 lists inbox
    datasite: client2@sandbox.local
    run: |
      out=""
      for i in $(seq 1 30); do
        out="$({{workspace}}/cli/target/release/bv inbox --plain --json --all)"
        if echo "$out" | jq -e '.messages[] | select(.message_type.Project != null)' >/dev/null 2>&1; then
          break
        fi
        {{workspace}}/cli/target/release/bv message sync --no-cleanup >/dev/null 2>&1 || true
        sleep 1
      done
      echo "$out"
    capture: c2_inbox

  - name: Extract project message IDs
    datasite: aggregator@sandbox.local
    run: |
      jq -r '.messages[] | select(.message_type.Project != null and .to == "aggregator@sandbox.local") | .id' <<< '{{agg_inbox}}' | head -n 1
    capture: agg_msg

  - name: Extract client1 project message ID
    datasite: client1@sandbox.local
    run: |
      jq -r '.messages[] | select(.message_type.Project != null and .to == "client1@sandbox.local") | .id' <<< '{{c1_inbox}}' | head -n 1
    capture: c1_msg

  - name: Extract client2 project message ID
    datasite: client2@sandbox.local
    run: |
      jq -r '.messages[] | select(.message_type.Project != null and .to == "client2@sandbox.local") | .id' <<< '{{c2_inbox}}' | head -n 1
    capture: c2_msg

  - name: Process Syqure allele-freq project concurrently
    datasite: aggregator@sandbox.local
    run: |
      bash {{workspace}}/tests/scripts/run_syqure_allele_freq_project.sh --sandbox "{{sandbox}}" --bv "{{workspace}}/cli/target/release/bv" --agg "{{agg_msg}}" --client1 "{{c1_msg}}" --client2 "{{c2_msg}}"

  - name: Wait for client1 sum_ac output
    datasite: client1@sandbox.local
    wait_for: .biovault/runs/{{c1_msg}}/results-test/sum_ac.txt
    timeout: 180

  - name: Wait for client2 sum_ac output
    datasite: client2@sandbox.local
    wait_for: .biovault/runs/{{c2_msg}}/results-test/sum_ac.txt
    timeout: 180
