name: WSL2 Probe (Namespace)

on:
  workflow_dispatch:

jobs:
  wsl2-probe:
    runs-on: namespace-profile-windows-medium
    timeout-minutes: 10
    steps:
      - name: Collect system diagnostics
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Continue'
          $log = Join-Path $env:GITHUB_WORKSPACE "wsl2-probe.log"
          function Write-Section([string]$title) {
            "`n=== $title ===" | Tee-Object -FilePath $log -Append
          }
          function Run-Cmd([string]$title, [scriptblock]$cmd) {
            Write-Section $title
            try { & $cmd 2>&1 | Tee-Object -FilePath $log -Append } catch { $_ | Tee-Object -FilePath $log -Append }
          }
          Write-Section "Timestamp"
          Get-Date | Tee-Object -FilePath $log -Append
          Run-Cmd "WhoAmI" { whoami }
          Run-Cmd "WhoAmI (groups)" { whoami /all }
          Run-Cmd "SystemInfo" { systeminfo }
          Run-Cmd "ComputerInfo (selected)" {
            Get-ComputerInfo |
              Select-Object OsName,OsVersion,OsBuildNumber,WindowsProductName,WindowsVersion,OsHardwareAbstractionLayer,HyperVisorPresent |
              Format-List
          }
          Run-Cmd "WSL Executable Version" {
            Get-Item "C:\\Windows\\System32\\wsl.exe" | Select-Object Name,VersionInfo
          }
          Run-Cmd "Windows Optional Features" {
            $features = @(
              "Microsoft-Windows-Subsystem-Linux",
              "VirtualMachinePlatform",
              "Microsoft-Hyper-V",
              "Microsoft-Hyper-V-All"
            )
            $results = foreach ($feature in $features) {
              Get-WindowsOptionalFeature -Online -FeatureName $feature
            }
            $results | Select-Object FeatureName,State | Format-Table -AutoSize | Out-String
          }
          Run-Cmd "DISM Feature Info (WSL/VM)" {
            dism /online /Get-FeatureInfo /FeatureName:Microsoft-Windows-Subsystem-Linux
            dism /online /Get-FeatureInfo /FeatureName:VirtualMachinePlatform
          }
          Run-Cmd "Services (LxssManager/vmcompute)" {
            Get-Service LxssManager,vmcompute | Format-Table -AutoSize
            sc.exe qc LxssManager
            sc.exe qc vmcompute
          }
          Run-Cmd "Service Start (LxssManager)" {
            Start-Service LxssManager
            Get-Service LxssManager | Format-Table -AutoSize
            sc.exe query LxssManager
            sc.exe sdshow LxssManager
          }
          Run-Cmd "WSL Event Log (Operational)" {
            Get-WinEvent -LogName "Microsoft-Windows-Lxss/Operational" -MaxEvents 50 |
              Select-Object TimeCreated,Id,LevelDisplayName,Message |
              Format-List
          }
          Run-Cmd "WSL Policy (registry)" {
            reg query "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsSubsystemForLinux" /s
          }
          Run-Cmd "WSL Lxss (registry)" {
            reg query "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Lxss" /s
          }
          Run-Cmd "WSL --version" { wsl --version }
          Run-Cmd "WSL --status" { wsl --status }
          Run-Cmd "WSL -l -v" { wsl -l -v }
          Run-Cmd "WSL -l -q" { wsl -l -q }
          Run-Cmd "WSL -l -o" { wsl -l -o }
          if ($LASTEXITCODE -ne 0) { $global:LASTEXITCODE = 0 }
          exit 0

      - name: Attempt WSL2 install or upgrade
        shell: pwsh
        continue-on-error: true
        run: |
          $ErrorActionPreference = 'Continue'
          $log = Join-Path $env:GITHUB_WORKSPACE "wsl2-probe.log"
          function Write-Section([string]$title) {
            "`n=== $title ===" | Tee-Object -FilePath $log -Append
          }
          $dist = "Ubuntu-24.04"
          Write-Section "Set default WSL version 2"
          wsl --set-default-version 2 2>&1 | Tee-Object -FilePath $log -Append
          Write-Section "Check existing distros"
          $installed = (wsl -l -q) | ForEach-Object { $_.Trim() } | Where-Object { $_ -eq $dist }
          if (-not $installed) {
            Write-Section "Install $dist"
            wsl --install -d $dist 2>&1 | Tee-Object -FilePath $log -Append
          } else {
            Write-Section "Set $dist to WSL2"
            wsl --set-version $dist 2 2>&1 | Tee-Object -FilePath $log -Append
          }
          if ($LASTEXITCODE -ne 0) { $global:LASTEXITCODE = 0 }
          exit 0

      - name: Verify Ubuntu-24.04
        shell: pwsh
        continue-on-error: true
        run: |
          $ErrorActionPreference = 'Continue'
          $log = Join-Path $env:GITHUB_WORKSPACE "wsl2-probe.log"
          function Write-Section([string]$title) {
            "`n=== $title ===" | Tee-Object -FilePath $log -Append
          }
          Write-Section "WSL list after install"
          wsl -l -v 2>&1 | Tee-Object -FilePath $log -Append
          Write-Section "WSL uname"
          wsl -d Ubuntu-24.04 --exec uname -a 2>&1 | Tee-Object -FilePath $log -Append
          Write-Section "WSL os-release"
          wsl -d Ubuntu-24.04 --exec cat /etc/os-release 2>&1 | Tee-Object -FilePath $log -Append

      - name: Upload diagnostics
        uses: actions/upload-artifact@v4
        with:
          name: wsl2-probe-logs
          path: wsl2-probe.log

      - name: Fail if WSL2 is not ready
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Continue'
          $log = Join-Path $env:GITHUB_WORKSPACE "wsl2-probe.log"
          function Write-Section([string]$title) {
            "`n=== $title ===" | Tee-Object -FilePath $log -Append
          }
          $dist = "Ubuntu-24.04"
          Write-Section "Final readiness check"
          $list = wsl -l -v 2>&1
          $list | Tee-Object -FilePath $log -Append
          if ($LASTEXITCODE -ne 0) {
            Write-Section "WSL list failed"
            exit 1
          }
          $distLine = $list | Where-Object { $_ -match "Ubuntu-24\\.04" }
          if (-not $distLine) {
            Write-Section "Ubuntu-24.04 not present"
            exit 1
          }
          if ($distLine -notmatch "\\s+2\\s*$") {
            Write-Section "Ubuntu-24.04 not WSL2"
            exit 1
          }
